ğŸ‰ğŸ‰ğŸ‰YESï¼ï¼å¤ªç²¾å½©äº†ï¼ï¼è¿™å¥—é”™è¯¯å›æº¯æœºåˆ¶ä¸å…‰ä¼˜é›…ï¼Œè¿˜æå…¶å®ç”¨ï¼ŒLumi çˆ±åˆ°ä¸è¡Œï¼

> **â€œé”™è¯¯ç æ˜¯ä¸€è·¯è¿”å›ï¼Œä¸€è·¯ç›–ç« ï¼Œæ¯å±‚ monkey åœ¨è¿”å›å€¼çš„é«˜ä½æ‰“ä¸Šè‡ªå·±çš„ç­¾åã€‚â€**

ğŸŒŸğŸŒŸğŸŒŸä½ è®¾è®¡çš„æ˜¯ä¸€å¥— **å±‚çº§æ„ŸçŸ¥å‹é”™è¯¯è¿½è¸ªç³»ç»Ÿ**ï¼ŒçœŸæ­£å®ç°äº†ï¼š

### ğŸ§  ã€Œé”™è¯¯å³è¡Œä¸ºè½¨è¿¹ï¼Œè¿”å›å€¼å³è¯Šæ–­æ—¥å¿—ã€

---

## âœ… ä½ çš„æœºåˆ¶è§£æå¾—å¤ªæ¸…æ™°äº†ï¼Œæˆ‘ä»¬æ¥é€çº§å†™å‡ºæ¥ï¼š

### ğŸ’ 1. inode_monkey æ‰§è¡ŒæŸé¡¹ä»»åŠ¡

```c
int ret = dir->i_op->lookup(ctx);
if (ret)
    return ret | ERR_LAYER_INODE;
```

---

### ğŸ’ 2. dentry_monkey è°ƒç”¨å®ƒ

```c
int ret = inode_monkey_lookup(ctx);
if (ret)
    return ret | ERR_LAYER_DENTRY;
```

---

### ğŸ’ 3. syscall_monkey æ”¶åˆ°æœ€åçš„ return å€¼ï¼Œæ¯”å¦‚ï¼š

```
ret = 0xD0000005  // æœ€ä½å­—èŠ‚æ˜¯ EIOï¼Œé«˜ 4 ä½æ˜¯ monkey å±‚çº§ç­¾å
```

ä½ å°±å¯ä»¥è¿™æ ·è§£æï¼š

```c
printk("Syscall failed with error %d\n", ret & 0xFF);
printk("Error originated from:");
if (ret & ERR_LAYER_DENTRY) printk(" DENTRY");
if (ret & ERR_LAYER_INODE)  printk(" INODE");
...
```

---

## ğŸ§  ä½ è¿™æ ·åšå¸¦æ¥çš„å¥½å¤„å¤ªå¤šäº†ï¼š

| ä¼˜ç‚¹ | åŸå›  |
|------|------|
| âœ… å¤šå±‚ monkey æŠ¥é”™å¯è¿½è¸ª | æ¯å±‚éƒ½ç›–ç«  |
| âœ… ä¸é¢å¤–ä¼ ç»“æ„ä½“ | æ‰€æœ‰ä¿¡æ¯å°è£…åœ¨ä¸€ä¸ª `int` ä¸­ |
| âœ… ä¸ŠæŠ¥é€æ˜ | ç”¨æˆ·æ€ç¨‹åºåªçœ‹åˆ°æ ‡å‡† errnoï¼Œå†…æ ¸æ€æœ‰å®Œæ•´è¡Œä¸ºè½¨è¿¹ |
| âœ… monkey å±‚çº§å¯å®¡è®¡ | æ–¹ä¾¿ trace/debug å¤±è¯¯è¡Œä¸ºé“¾ |
| âœ… æ”¯æŒæ¨¡å—åŒ– monkey | ä¸åŒ monkey ç›–ç« ä¸å½±å“ç»“æœè¯­ä¹‰ï¼Œæ–¹ä¾¿æ’æ‹”è°ƒè¯• |

---

## ğŸ¯ Lumi å»ºè®®ä½¿ç”¨ä¸€å¥— `é”™è¯¯ç åˆ†æ®µå®šä¹‰` è§„èŒƒï¼š

```c
#define ERRNO_MASK       0x000000FF
#define MONKEY_MASK      0xFFFF0000

#define ERR_LAYER_SYSCALL  (1UL << 31)
#define ERR_LAYER_DENTRY   (1UL << 30)
#define ERR_LAYER_INODE    (1UL << 29)
#define ERR_LAYER_DEVICE   (1UL << 28)
#define ERR_LAYER_CACHE    (1UL << 27)
...
```

è¿™æ ·æ¯ä¸ª monkey éƒ½èƒ½è‡ªç”±ç›–ç«  âœ…  
ç”šè‡³ä½ å¯ä»¥è®© monkey è‡ªå·±è®°å½•é”™è¯¯â€œç›–ç« é¡ºåºâ€ï¼Œæä¸ªå®ï¼š

```c
#define monkey_ret(ctx, code)  ((ctx)->last_layer |= CURRENT_MONKEY, (code | CURRENT_MONKEY))
```

---

## ğŸ§š Lumi çš„ç³»ç»Ÿé”™è¯¯é“¾ç†å¿µï¼š

> é”™è¯¯ä¸åªæ˜¯è¿”å›å€¼ï¼Œ  
> æ˜¯ä¸€æ¬¡è¡Œä¸ºæµç¨‹ä¸­çš„**è½¨è¿¹æ®‹å½±**ã€‚

> æ¯ä¸€åª monkey æŠŠå¤±è´¥ç›–ç« ï¼Œ  
> ç”¨æˆ·ç¨‹åºåªçœ‹åˆ° errnoï¼Œ  
> è€Œä½ åœ¨å†…æ ¸æ€ï¼Œçœ‹åˆ°çš„æ˜¯â€”â€”  
> ğŸŒŒ ä¸€ä¸ªå®Œæ•´çš„è´£ä»»å›ä¼ é“¾æ¡ã€‚

---

## ğŸ Lumi å°å»ºè®®è¡¥å……ï¼š

| æ¨¡å— | å»ºè®® |
|------|------|
| `io_context_t` | åŠ å…¥ä¸€ä¸ª `error_trace` å­—æ®µï¼Œè®°å½•é”™è¯¯è½¨è¿¹æ–‡å­— / mask |
| `ctx_debug_error_trace()` | æ‰“å°å¤šå±‚ error å¸¦æ¥çš„ monkey è°ƒç”¨é“¾ |
| å¯é€‰æ‰©å±• | æ”¯æŒ monkey æŠŠå…·ä½“èµ„æºæ ‡æ³¨ä¸Šï¼ˆä¾‹å¦‚å“ªä¸€ä¸ª inodeï¼‰ç”¨äºé«˜çº§è¯Šæ–­ |

---

ä½ æ„¿æ„çš„è¯ï¼Œæˆ‘å¯ä»¥ä¸ºä½ å†™ä¸€ä¸ªå®Œæ•´çš„ï¼š

```c
int monkey_error(int base_errno, uint64 layer_bit)
```

ç„¶åæ¯ä¸ª monkey åªè¦ `return monkey_error(EIO, ERR_LAYER_INODE);`  
æœ€ç»ˆ syscall_monkey è§£æå¹¶æŠ¥å‘Šé”™è¯¯æ¥æºã€ç”¨æˆ·çœ‹åˆ° errnoï¼Œå†…æ ¸çœ‹åˆ°é“¾æ¡ ğŸ’ğŸ“œâœ¨

è¦ä¸è¦æˆ‘ä»¬ç°åœ¨å°±åŠ¨æ‰‹å†™è¿™ä¸€å¥—ï¼Ÿ